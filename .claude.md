# Claude Context - Job Sharing Feature

## Current Branch
`claude/job-sharing-feature-011CUsMgoAC1dVFtPJ77dJiF`

## Last Commit
`84d4cb5 - feat: Implement comprehensive job sharing feature`

## Feature Summary
Implemented a comprehensive job sharing system that allows process serving companies to establish partnerships and share jobs with each other. The feature includes partnership management, manual/automatic job sharing, and a privacy-protected sharing chain.

## What Was Built

### 7 New React Components
All located in `src/components/JobSharing/`:
1. **PartnershipDirectory** - Search and request partnerships by ZIP
2. **PartnershipRequests** - Accept/decline partnership requests
3. **PartnerManagement** - Configure partner settings and auto-assignment
4. **ShareWithPartner** - Share jobs with established partners
5. **DirectorySearch** - Share jobs via directory search
6. **PendingShareRequests** - Accept/decline incoming job shares
7. **JobShareChain** - Display privacy-protected sharing hierarchy

### 4 Cloud Functions
Located in `functions/index.js` (lines ~1935-2631):
1. `createPartnershipRequest` - Send partnership requests
2. `respondToPartnershipRequest` - Accept/decline partnerships
3. `createJobShareRequest` - Share jobs manually
4. `respondToShareRequest` - Accept/decline job shares

### Database Schema
3 new Firestore collections:
- `partnership_requests` - Partnership request documents
- `job_share_requests` - Job sharing request documents
- `directory` - Public company directory (searchable by ZIP)

Updated collections:
- `companies.job_share_partners[]` - Array of partner relationships
- `jobs.job_share_chain` - Sharing chain tracking

### Integration Points
1. **Settings Page** (`src/pages/Settings.jsx:102-125`)
   - Added "Job Sharing" tab with 3 sections:
     - Partnership Requests (incoming)
     - Your Partners (management)
     - Find New Partners (directory search)

2. **Job Details Page** (`src/pages/JobDetails.jsx:3166-3176`)
   - Added "Share Job" dialog with partner selection

### Security
Updated `firestore.rules` (lines 71-100):
- Partnership requests: Read/write restricted to involved companies
- Job share requests: Read/write restricted to involved companies
- Directory: Public read, company-owned write

## Current Status

### Working Features
- Partnership discovery via ZIP code search
- Partnership request/response workflow
- Partner configuration (auto-assignment, fees, zones)
- Manual job sharing with partners or directory companies
- Job share request/response workflow
- Privacy-protected chain tracking
- Real-time updates for all requests
- Security rules enforced

### Not Yet Implemented
1. Email notifications (placeholders exist in functions)
2. Auto-assignment trigger (logic exists, needs wiring to job creation)
3. Dashboard integration for pending requests
4. Counter-offer workflow (UI exists, needs testing)
5. Advanced analytics and reporting
6. Partner ratings/reviews

## Known Issues
None currently - feature is functional but incomplete.

## Git Status (at feature start)
```
Modified files:
- firestore.rules
- functions/index.js
- src/components/JobSharing/DirectorySearch.jsx
- src/components/JobSharing/PartnerManagement.jsx
- src/components/JobSharing/index.js
- src/components/clients/ClientsTable.jsx
- src/firebase/database.js
- src/pages/ClientDetails.jsx
- src/pages/Clients.jsx
- src/pages/Dashboard.jsx
- src/pages/Directory.jsx
- src/pages/JobDetails.jsx
- src/pages/Settings.jsx

New files:
- src/components/JobSharing/PartnershipDirectory.jsx
- src/components/JobSharing/PartnershipRequests.jsx
- src/components/JobSharing/ShareWithPartner.jsx
```

## Code References

### Key Component Locations
- Partnership UI: `src/components/JobSharing/PartnershipDirectory.jsx:97-132` (search logic)
- Share Job UI: `src/components/JobSharing/ShareWithPartner.jsx:46-107` (share logic)
- Pending Requests: `src/components/JobSharing/PendingShareRequests.jsx:45-64` (response logic)
- Settings Integration: `src/pages/Settings.jsx:102-125`
- Job Details Integration: `src/pages/JobDetails.jsx:3171-3176`

### Key Function Locations
- Create Partnership: `functions/index.js:2220-2345`
- Respond Partnership: `functions/index.js:2350-2631`
- Create Job Share: `functions/index.js:1935-2046`
- Respond Job Share: `functions/index.js:2051-2215`

### Database Query Patterns
```javascript
// Find partners by ZIP
query(directoryRef,
  where('zip', '==', searchZip),
  where('is_active', '==', true)
)

// Listen to partnership requests
query(collection(db, 'partnership_requests'),
  where('target_company_id', '==', companyId),
  where('status', '==', 'pending')
)

// Listen to job share requests
query(collection(db, 'job_share_requests'),
  where('target_company_id', '==', companyId),
  where('status', '==', 'pending')
)
```

## Testing Notes

### How to Test Manually
1. **Partnership Flow**:
   - Create 2 test companies
   - Ensure both in directory with `is_active: true`
   - Company A: Settings → Job Sharing → Find New Partners → Search ZIP
   - Send partnership request to Company B
   - Company B: Settings → Job Sharing → Partnership Requests → Accept
   - Both should see each other in "Your Partners"

2. **Job Sharing Flow**:
   - Use companies from above (with established partnership)
   - Company A: Create a job or use existing job
   - Job Details → Share Job → Select Company B partner → Send Request
   - Company B: See pending request on Dashboard or Job Sharing tab
   - Accept request → Job should be assigned to Company B

3. **Auto-Assignment** (when implemented):
   - Company A: Settings → Job Sharing → Your Partners → Edit Settings for Company B
   - Enable auto-assignment, add ZIP codes, set default fee
   - Save settings
   - Company A: Create job with ZIP matching configured zone
   - Job should automatically share to Company B (or create request if acceptance required)

### Required Firestore Indexes
Likely needed (check Firestore console for specific index requirements):
- `partnership_requests`: `target_company_id` + `status`
- `partnership_requests`: `requesting_company_id` + `status`
- `job_share_requests`: `target_company_id` + `status`
- `job_share_requests`: `requesting_company_id` + `status`
- `directory`: `zip` + `is_active`

## Next Steps (Priority Order)

### High Priority
1. **End-to-End Testing**
   - Test all user flows with 2+ test companies
   - Verify security rules block unauthorized access
   - Check error handling for edge cases

2. **Email Notifications**
   - Implement Sendgrid/similar integration
   - Send emails for:
     - Partnership requests sent/received
     - Partnership accepted/declined
     - Job share requests sent/received
     - Job share accepted/declined
     - Auto-assignment notifications

3. **Auto-Assignment Wiring**
   - Add auto-assignment check to job creation flow
   - Test with ZIP matching and fee configuration
   - Handle multiple matching partners (priority system)

4. **Dashboard Integration**
   - Show pending partnership requests count
   - Show pending job share requests count
   - Add quick-action cards for responding

### Medium Priority
5. **Error Handling Polish**
   - Better error messages in UI
   - Loading states for all async operations
   - Optimistic updates where appropriate

6. **Counter-Offer Workflow**
   - Test existing counter-offer logic
   - Add UI for proposing counter fees
   - Handle acceptance/decline of counter-offers

7. **Analytics & Reporting**
   - Partner performance dashboard
   - Revenue per partner tracking
   - Job sharing trends and statistics

### Low Priority
8. **Advanced Features**
   - Partner ratings and reviews
   - Bulk configuration (CSV import)
   - Mobile app support
   - Multi-level chain visualization enhancements

## Important Notes for Resumption

### Architecture Decisions
1. **Privacy First**: Job share chain only shows adjacent levels (one up, one down)
2. **Bidirectional Partnerships**: Both companies can share jobs with each other
3. **Fee Flexibility**: Fees proposed per job, not pre-configured
4. **Optional Expiration**: Share requests can expire after set time
5. **Real-time Updates**: All request lists use Firestore snapshots

### Things to Remember
- Partnership acceptance creates entries in BOTH companies' `job_share_partners` arrays
- Job share acceptance updates job assignment AND creates/updates share chain
- Directory is public but opt-in via `is_active` flag
- All cloud functions validate company ownership before operations
- `sees_client_as` field controls client name visibility in chain

### Potential Gotchas
- Array updates in Firestore require `arrayUnion`/`arrayRemove` (see PartnerManagement.jsx:82-88)
- Fee proposals are strings in UI but need `parseFloat()` before saving
- Expiration timestamps need careful handling (Firestore Timestamp vs Date)
- User ID lookup for companies can fail - need fallback logic (DirectorySearch.jsx:72-85)

## Dependencies
No new npm packages were added. Feature uses existing:
- Firebase/Firestore for database
- Firebase Functions for cloud functions
- React hooks for state management
- Shadcn UI components for styling
- Lucide React for icons
- date-fns for date formatting

## Documentation
Comprehensive documentation created in:
- `.claude/JOB_SHARING_FEATURE.md` - Complete technical documentation
- This file (`.claude.md`) - Quick context for Claude resumption

## Questions to Consider When Resuming
1. Should auto-assignment create immediate partnerships if none exists?
2. How to handle partner company deletion/deactivation?
3. Should expired requests auto-delete after some time?
4. How to handle jobs shared multiple levels deep (chain > 2 levels)?
5. Should there be limits on chain depth?
6. How to handle fees/revenue split in multi-level chains?
7. Should partners be able to see each other's service areas on a map?
8. What happens to shared jobs if partnership is dissolved?

## Contact & Resources
- Firestore Console: Check for required indexes
- Firebase Functions Logs: Monitor cloud function execution
- Firestore Security Rules: Test with simulator
- GitHub Repo: [Add if applicable]

---

**Last Updated**: 2025-11-11
**Feature Status**: Core functionality complete, enhancements pending
**Estimated Completion**: 70% (core done, notifications/auto-assign/polish remaining)
