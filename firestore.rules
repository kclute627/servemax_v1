rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user's company_id from their Firestore document
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id;
    }

    // Helper function to check if user owns or has access to company data
    function hasCompanyAccess(companyId) {
      return isAuthenticated() &&
             (resource.data.company_id == companyId ||
              getUserCompanyId() == companyId);
    }

    // Helper function to check if user is a super admin
    function isSuperAdmin() {
      return isAuthenticated() && (
        // Check Firestore user document fields
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.is_super_admin == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        // Check email address directly from auth token
        request.auth.token.email == 'kyclutter@gmail.comm'
      );
    }

    // Users collection - users can read/write their own data
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Companies collection - authenticated users can read any company (needed for directory/partnerships)
    // Users can create new companies during registration, and update their own company
    match /companies/{companyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Allow company creation during registration
      // Allow update if: 1) updating your own company, OR 2) updating a client you created, OR 3) super admin
      allow update, delete: if isAuthenticated() && (
        getUserCompanyId() == companyId ||
        resource.data.created_by == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Stats collections - company members can read their company's stats
    match /company_stats/{docId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow write: if false; // Stats are written by server-side functions only
    }

    match /client_stats/{docId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow write: if false; // Stats are written by server-side functions only
    }

    match /server_stats/{docId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow write: if false; // Stats are written by server-side functions only
    }

    // Directory collection - public read, company owners can write their own
    match /directory/{companyId} {
      allow read: if true; // Public directory
      allow write: if isAuthenticated() &&
                     getUserCompanyId() == companyId;
    }

    // Invitations - company admins can create, invited users can read/accept
    match /invitations/{invitationId} {
      allow read: if isAuthenticated() &&
                    (resource.data.email == request.auth.token.email ||
                     resource.data.company_id == getUserCompanyId());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                      resource.data.email == request.auth.token.email;
    }

    // Partnership requests - users can only see requests to/from their company
    match /partnership_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesting_company_id == getUserCompanyId() ||
        resource.data.target_company_id == getUserCompanyId()
      );

      allow create: if isAuthenticated() &&
        request.resource.data.requesting_company_id == getUserCompanyId();

      allow update: if isAuthenticated() && (
        resource.data.requesting_company_id == getUserCompanyId() ||
        resource.data.target_company_id == getUserCompanyId()
      );
    }

    // Job share requests - users can only see requests to/from their company
    match /job_share_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesting_company_id == getUserCompanyId() ||
        resource.data.target_company_id == getUserCompanyId()
      );

      allow create: if isAuthenticated() &&
        getUserCompanyId() == request.resource.data.requesting_company_id;

      allow update: if isAuthenticated() &&
        getUserCompanyId() == resource.data.target_company_id &&
        request.resource.data.status in ['accepted', 'declined'];
    }

    // Notifications - users can read/update notifications for their company
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      // Allow users to mark notifications as read
      allow update: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      // Only cloud functions can create/delete notifications
      allow create, delete: if false;
    }

    // Jobs - enhanced to support job sharing chain and carbon copy
    match /jobs/{jobId} {
      // Helper function to check if user is in the legacy job share chain
      function isInLegacyShareChain() {
        return resource.data.job_share_chain != null &&
               resource.data.job_share_chain.is_shared == true &&
               getUserCompanyId() in resource.data.job_share_chain.chain[0].company_id;
      }

      // Helper function to check if user is in the carbon copy share chain
      function isInCarbonCopyChain() {
        return resource.data.share_chain != null && (
          // User's company is the parent or child in the chain
          resource.data.share_chain.parent_company_id == getUserCompanyId() ||
          resource.data.share_chain.child_company_id == getUserCompanyId() ||
          // Or user's company ID is in the all_job_ids related companies
          // Note: all_job_ids contains job IDs, not company IDs, so we check parent/child
          resource.data.share_chain.root_company_id == getUserCompanyId()
        );
      }

      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isInLegacyShareChain() ||
        isInCarbonCopyChain() ||
        isSuperAdmin()
      );

      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();

      // Allow update if user owns the job OR is in the share chain (for status sync)
      allow update: if isAuthenticated() && (
        hasCompanyAccess(resource.data.company_id) ||
        isInCarbonCopyChain() ||
        isSuperAdmin()
      );

      allow delete: if isAuthenticated() && (
        hasCompanyAccess(resource.data.company_id) ||
        isSuperAdmin()
      );
    }

    // Attempts - visible to all companies in the chain
    match /attempts/{attemptId} {
      // Helper to check chain visibility
      function isVisibleToCompany() {
        return resource.data.visible_to_companies != null &&
               getUserCompanyId() in resource.data.visible_to_companies;
      }

      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isVisibleToCompany()
      );

      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();

      allow update, delete: if isAuthenticated() &&
                              hasCompanyAccess(resource.data.company_id);
    }

    // Company Settings - users can read/write any settings (structure varies)
    match /company_settings/{settingId} {
      allow read, write: if isAuthenticated();
    }

    // Server Pay Records - users can read/write their company's records only
    match /server_pay_records/{recordId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() && (
        request.resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Clients - users can read/write their company's clients
    match /clients/{clientId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Servers - users can read/write their company's servers
    match /servers/{serverId} {
      allow read: if isAuthenticated() &&
                    resource.data.company_id == getUserCompanyId();
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() &&
                              resource.data.company_id == getUserCompanyId();
    }

    // Documents - users can read/write their company's documents
    match /documents/{documentId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Templates - users can read/write their company's templates
    match /templates/{templateId} {
      allow read: if isAuthenticated() &&
                    resource.data.company_id == getUserCompanyId();
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() &&
                              resource.data.company_id == getUserCompanyId();
    }

    // Employees - users can read/write their company's employees
    match /employees/{employeeId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Court Cases - users can read/write their company's court cases
    match /court_cases/{caseId} {
      allow read: if isAuthenticated() && (
        resource.data.created_by == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.created_by == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.created_by == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Courts - users can read/write courts they created
    match /courts/{courtId} {
      allow read: if isAuthenticated() &&
                    resource.data.created_by == getUserCompanyId();
      allow create: if isAuthenticated() &&
                      request.resource.data.created_by == getUserCompanyId();
      allow update, delete: if isAuthenticated() &&
                              resource.data.created_by == getUserCompanyId();
    }

    // Invoices - users can read/write their company's invoices
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Payments - users can read/write their company's payments
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Affidavits - users can read/write their company's affidavits
    match /affidavits/{affidavitId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Service Logs - users can read/write their company's service logs
    match /service_logs/{logId} {
      allow read: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
      allow create: if isAuthenticated() &&
                      request.resource.data.company_id == getUserCompanyId();
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id == getUserCompanyId() ||
        isSuperAdmin()
      );
    }

    // Universal Courts - platform-wide shared court database
    // All authenticated users can read and contribute to build a knowledge base
    match /universal_courts/{courtId} {
      allow read: if isAuthenticated();

      // Allow creating new courts with required fields
      allow create: if isAuthenticated() &&
                      request.resource.data.full_court_name != null &&
                      request.resource.data.full_court_name_lower != null &&
                      request.resource.data.court_address1 != null;

      // Allow updates for incrementing lookup count and updating timestamps
      allow update: if isAuthenticated();
    }

    // Counters - global counters for sequential numbering (e.g., job numbers)
    match /counters/{counterId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Allow creating and incrementing counters when creating jobs
    }

    // Affidavit Templates - DEPRECATED - consolidated into system_affidavit_templates
    // match /affidavit_templates/{templateId} {
    //   allow read: if isAuthenticated() && (
    //     resource.data.company_id == getUserCompanyId() ||
    //     isSuperAdmin()
    //   );
    //   allow create: if isAuthenticated() &&
    //                   request.resource.data.company_id == getUserCompanyId();
    //   allow update, delete: if isAuthenticated() && (
    //     resource.data.company_id == getUserCompanyId() ||
    //     isSuperAdmin()
    //   );
    // }

    // System Affidavit Templates - all templates with visibility control via who_can_see field
    match /system_affidavit_templates/{templateId} {
      // Allow read if template is for everyone OR user's company is in the who_can_see array
      // During migration, treat templates without who_can_see as system templates (visible to all)
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        resource.data.who_can_see == "everyone" ||
        (resource.data.who_can_see is list && getUserCompanyId() in resource.data.who_can_see) ||
        !('who_can_see' in resource.data) // Migration: allow reading old templates without who_can_see
      );

      // Allow create for any authenticated user
      allow create: if isAuthenticated();

      // Allow update/delete if:
      // 1. User is a super admin (can edit all templates including system templates), OR
      // 2. User's company is in who_can_see list (for company-specific templates), OR
      // 3. Template has no who_can_see field (migration support)
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() ||
        (resource.data.who_can_see is list && getUserCompanyId() in resource.data.who_can_see) ||
        !('who_can_see' in resource.data) // Migration: allow updating old templates
      );
    }

    // Pricing Plans - platform-wide subscription/pricing configuration
    match /pricing_plans/{planId} {
      allow read: if isAuthenticated(); // All users can read pricing plans
      allow write: if isSuperAdmin(); // Only super admins can create/update/delete pricing plans
    }

    // Subscriptions - platform subscription records
    match /subscriptions/{subscriptionId} {
      allow read, write: if isSuperAdmin(); // Only super admins can access subscription data
    }

    // Users collection - allow users to read their own document
    // This is REQUIRED for isSuperAdmin() function to work
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if false; // Users are managed by Firebase Auth, not direct writes
    }
  }
}